# 1. р╕Щр╕│р╣Ар╕Вр╣Йр╕▓р╕Др╕ер╕▓р╕кр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣Мр╕Хр╣Ир╕▓р╕Зр╣Ж
from comunucation import ModbusTCP
from Logging_andplot import Logger
from generate_signal import TestRunner
import sys

# ==============================================================================
# ---> р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Др╕В <---
# ==============================================================================
# 1. р╕Бр╕│р╕лр╕Щр╕Фр╕Др╣Ир╕▓ IP р╣Бр╕ер╕░ Port р╕Вр╕нр╕Зр╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М PLC р╕лр╕гр╕╖р╕н Modbus Server р╕Вр╕нр╕Зр╕Др╕╕р╕У
HOST_IP = '192.168.1.100'
HOST_PORT = 502

# 2. р╣Ар╕ер╕╖р╕нр╕Бр╕зр╣Ир╕▓р╕Ир╕░р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕кр╕▒р╕Нр╕Нр╕▓р╕Ур╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕З (р╣Ар╕ер╕╖р╕нр╕Бр╕Ир╕▓р╕Б: "step", "ramp", "sine", "square" р╕пр╕ер╕п)
SIGNALS_TO_RUN = ["step", "sine", "ramp"]

# 3. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ
SAMPLING_TIME = 0.1      # р╕Др╕зр╕▓р╕бр╣Ар╕гр╣Зр╕зр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕е (0.1 = 10 р╕Др╕гр╕▒р╣Йр╕З/р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)
SIGNAL_DURATION = 10     # р╕Др╕зр╕▓р╕бр╕вр╕▓р╕зр╕Вр╕нр╕Зр╣Бр╕Хр╣Ир╕ер╕░р╕кр╕▒р╕Нр╕Нр╕▓р╕У (р╕лр╕Щр╣Ир╕зр╕в: р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)
SLEEP_BETWEEN = 3        # р╣Ар╕зр╕ер╕▓р╕Юр╕▒р╕Бр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕кр╕▒р╕Нр╕Нр╕▓р╕У (р╕лр╕Щр╣Ир╕зр╕в: р╕зр╕┤р╕Щр╕▓р╕Чр╕╡)
# ==============================================================================


def main():
    """
    р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Бр╣Гр╕Щр╕Бр╕▓р╕гр╕Др╕зр╕Ър╕Др╕╕р╕бр╕Бр╕гр╕░р╕Ър╕зр╕Щр╕Бр╕▓р╕гр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
    """
    # р╣Ар╕Хр╕гр╕╡р╕вр╕б object р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕е (Logger) р╣Бр╕ер╕░р╕Бр╕▓р╕гр╕кр╕╖р╣Ир╕нр╕кр╕▓р╕г (ModbusTCP)
    logger = Logger()
    modbus = ModbusTCP(host=HOST_IP, port=HOST_PORT)

    try:
        # -- р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1: р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ър╕нр╕╕р╕Ыр╕Бр╕гр╕Ур╣М --
        print(f"р╕Бр╕│р╕ер╕▒р╕Зр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ Modbus Server р╕Чр╕╡р╣И {HOST_IP}:{HOST_PORT}...")
        if not modbus.connect():
            print("тЭМ р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з! р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ IP Address р╕лр╕гр╕╖р╕нр╕кр╕▓р╕в LAN")
            sys.exit() # р╕нр╕нр╕Бр╕Ир╕▓р╕Бр╣Вр╕Ыр╕гр╣Бр╕Бр╕гр╕бр╕Чр╕▒р╕Щр╕Чр╕╡р╕Цр╣Йр╕▓р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╣Др╕бр╣Ир╣Др╕Фр╣Й
        print("тЬЕ р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕кр╕│р╣Ар╕гр╣Зр╕И!")

        # -- р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 2: р╕кр╕гр╣Йр╕▓р╕Зр╕Хр╕▒р╕зр╕кр╕▒р╣Ир╕Зр╕Зр╕▓р╕Щ TestRunner --
        #    (р╕кр╣Ир╕З modbus р╣Бр╕ер╕░ logger р╣Ар╕Вр╣Йр╕▓р╣Др╕Ыр╣Гр╕лр╣Й TestRunner р╕гр╕╣р╣Йр╕Ир╕▒р╕Б)
        test_runner = TestRunner(modbus=modbus, logger=logger, sampling_time=SAMPLING_TIME)

        # -- р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 3: р╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ъ --
        print(f"\nЁЯЪА р╣Ар╕гр╕┤р╣Ир╕бр╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕кр╕▒р╕Нр╕Нр╕▓р╕У: {', '.join(SIGNALS_TO_RUN)}")
        test_runner.run_test(
            signals=SIGNALS_TO_RUN,
            signal_duration=SIGNAL_DURATION,
            sleep_between=SLEEP_BETWEEN
        )
        print("\nЁЯОЙ р╕Бр╕▓р╕гр╕Чр╕Фр╕кр╕нр╕Ър╣Ар╕кр╕гр╣Зр╕Ир╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М!")
        print("р╣Др╕Яр╕ер╣Мр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Цр╕╣р╕Бр╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╣Гр╕Щр╣Вр╕Яр╕ер╣Ар╕Фр╕нр╕гр╣М 'test_results'")

    except Exception as e:
        print(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╕гр╣Йр╕▓р╕вр╣Бр╕гр╕Зр╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕Чр╕│р╕Зр╕▓р╕Щ: {e}")

    finally:
        # -- р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 4: р╕Ыр╕┤р╕Фр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╣Ар╕кр╕бр╕н --
        #    (р╣Др╕бр╣Ир╕зр╣Ир╕▓р╕Ир╕░р╕Чр╕│р╕Зр╕▓р╕Щр╕кр╕│р╣Ар╕гр╣Зр╕Ир╕лр╕гр╕╖р╕нр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з р╕Бр╣Зр╕Хр╣Йр╕нр╕Зр╕Ыр╕┤р╕Фр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н)
        if modbus.client.connected:
            modbus.disconnect()
            print("ЁЯФМ р╕Ыр╕┤р╕Фр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕н Modbus р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕вр╣Бр╕ер╣Йр╕з")


# р╕кр╕▒р╣Ир╕Зр╣Гр╕лр╣Йр╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щ main() р╣Ар╕гр╕┤р╣Ир╕бр╕Чр╕│р╕Зр╕▓р╕Щр╣Ар╕бр╕╖р╣Ир╕нр╕гр╕▒р╕Щр╣Др╕Яр╕ер╣Мр╕Щр╕╡р╣Й
if __name__ == "__main__":
    main()